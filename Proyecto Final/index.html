<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Estudiantes</title>
    <!-- Carga de Tailwind CSS -->
<script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script>
<!-- Configuración de la fuente Inter y personalización de colores/estilos -->
<style>
@import url('https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DInter:wght%40100..900%26display%3Dswap');
body {
font-family: 'Inter', sans-serif;
/* Fondo muy claro, similar al de las páginas académicas /
background-color: #f7f9fb;
}
/ Estilos personalizados para la tabla (ejemplo: filas alternas) */
.table-row:nth-child(even) {
background-color: #f9fafb;
}
</style>
</head>
<body class="min-h-screen p-4 sm:p-8">
    <div id="app" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-t-8 border-indigo-600">
    
    <!-- CABECERA PRINCIPAL -->
    <header class="mb-10 pb-4">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-800 leading-tight">
            Sistema de Gestión Académica
        </h1>
        <p class="text-gray-600 mt-2 text-lg">Módulo de Registro de Estudiantes</p>
    </header>

    <!-- Sección de Autenticación y Estado -->
    <div id="auth-status" class="mb-8 flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-inner">
        <p id="user-info" class="text-base font-medium text-blue-800 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            Cargando autenticación...
        </p>
    </div>

    <!-- Formulario de Registro (Card con Sombra) -->
    <section id="registration-form" class="mb-12 p-8 border border-gray-100 rounded-xl bg-white shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b pb-3">
            <span class="border-b-2 border-indigo-500 pb-3">Registrar Nuevo Estudiante</span>
        </h2>
        
        <form id="student-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
            
            <!-- Nombre Completo -->
            <div>
                <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Nombre Completo</label>
                <input type="text" id="name" required
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-sm">
            </div>
            
            <!-- ID de Estudiante -->
            <div>
                <label for="studentId" class="block text-sm font-semibold text-gray-700 mb-1">ID de Estudiante</label>
                <input type="text" id="studentId" required
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-sm">
            </div>
            
            <!-- Email -->
            <div>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">Correo Electrónico</label>
                <input type="email" id="email" required
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-sm">
            </div>

            <!-- Fecha de Nacimiento -->
            <div>
                <label for="dob" class="block text-sm font-semibold text-gray-700 mb-1">Fecha de Nacimiento</label>
                <input type="date" id="dob" required
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-sm">
            </div>
            
            <!-- Grado/Nivel -->
            <div class="md:col-span-2">
                <label for="grade" class="block text-sm font-semibold text-gray-700 mb-1">Grado/Nivel</label>
                <select id="grade" required
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-sm">
                    <option value="">Seleccione un grado</option>
                    <option value="1">1° Grado</option>
                    <option value="2">2° Grado</option>
                    <option value="3">3° Grado</option>
                    <option value="4">4° Grado</option>
                    <option value="5">5° Grado</option>
                    <option value="6">6° Grado</option>
                    <option value="7">7° Grado</option>
                    <option value="8">8° Grado</option>
                    <option value="9">9° Grado</option>
                    <option value="10">10° Grado</option>
                    <option value="11">11° Grado</option>
                    <option value="12">12° Grado</option>
                </select>
            </div>

            <!-- Botón de Envío y Mensajes -->
            <div class="md:col-span-2 flex flex-col sm:flex-row items-center gap-4 mt-4 pt-4 border-t border-gray-100">
                <button type="submit" id="submit-btn"
                    class="w-full sm:w-auto px-8 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg shadow-indigo-200 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-[1.01] disabled:opacity-50 disabled:shadow-none">
                    Guardar Estudiante
                </button>
                <span id="form-message" class="text-sm font-medium transition-opacity duration-300"></span>
            </div>

        </form>
    </section>

    <!-- Lista de Estudiantes Registrados -->
    <section class="p-8 border border-gray-100 rounded-xl bg-white shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b pb-3 flex justify-between items-baseline">
            <span class="border-b-2 border-indigo-500 pb-3">Estudiantes Registrados</span>
            <span class="text-lg font-semibold text-gray-500">Total: <span id="student-count">0</span></span>
        </h2>

        <div id="students-list" class="overflow-x-auto rounded-xl border border-gray-200">
            <!-- La lista de estudiantes se insertará aquí -->
        </div>
        
        <div id="no-students" class="text-center p-8 text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-xl mt-4 hidden">
            <svg class="w-10 h-10 mx-auto mb-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292m0 5.292a4 4 0 110 5.292M12 20.25a8.25 8.25 0 100-16.5 8.25 8.25 0 000 16.5zM12 21.75a9.75 9.75 0 100-19.5 9.75 9.75 0 000 19.5z"></path></svg>
            <p class="font-medium">Aún no hay estudiantes registrados en este módulo.</p>
        </div>
    </section>

    <!-- Mensaje Modal/Toast (En lugar de alert()) -->
    <div id="toast-message" class="fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-2xl transition-all duration-500 opacity-0 translate-y-full" role="alert">
        <div id="toast-text" class="text-white font-medium flex items-center">
             <!-- Icono y texto se insertan aquí por el JS -->
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Establecer nivel de log para depuración de Firestore
    setLogLevel('debug');

    // --- Configuración e Inicialización de Firebase ---
    // Estas variables son provistas por el entorno de Canvas
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase config no disponible.");
        document.getElementById('user-info').textContent = 'Error: Configuración de Firebase no encontrada.';
        return;
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let userId = null;
    let isAuthReady = false;

    // Elementos del DOM
    const form = document.getElementById('student-form');
    const nameInput = document.getElementById('name');
    const studentIdInput = document.getElementById('studentId');
    const emailInput = document.getElementById('email');
    const dobInput = document.getElementById('dob');
    const gradeSelect = document.getElementById('grade');
    const submitBtn = document.getElementById('submit-btn');
    const formMessage = document.getElementById('form-message');
    const studentsListContainer = document.getElementById('students-list');
    const studentCountElement = document.getElementById('student-count');
    const noStudentsMessage = document.getElementById('no-students');

    // --- Funciones de Utilidad ---

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');
        
        // Icono para éxito (check) o error (x)
        const iconSvg = type === 'success' 
            ? '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
            : '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';

        toastText.innerHTML = `${iconSvg}<span>${message}</span>`;
        
        // Estilos del toast
        if (type === 'success') {
            toast.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-2xl transition-all duration-500 bg-green-600';
        } else if (type === 'error') {
            toast.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-2xl transition-all duration-500 bg-red-600';
        }

        // Mostrar
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-full');
        }, 10);

        // Ocultar después de 4 segundos
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-full');
        }, 4000);
    }

    // --- Lógica de Autenticación ---

    async function authenticateUser() {
        try {
            // Usamos la persistencia de sesión para que el usuario no se desautentique al refrescar
            await setPersistence(auth, browserSessionPersistence);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // Generar un ID anónimo si no hay token 
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Error al autenticar:", error);
            document.getElementById('user-info').textContent = `Error de Auth: ${error.message}`;
        }
    }

    // Observador de estado de autenticación
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            isAuthReady = true;
            // Actualizar info de usuario con el ID visible (requerido para apps multiusuario)
            document.getElementById('user-info').innerHTML = `
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 12a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a4 4 0 014-4h10a4 4 0 014 4v2z"></path></svg>
                Sesión activa. ID de Usuario: <span class="font-bold">${userId}</span>
            `;
            
            // Una vez autenticado, iniciar el listener de Firestore
            startStudentListener();
        } else {
            userId = null;
            isAuthReady = true;
            document.getElementById('user-info').textContent = 'Autenticación en curso o fallida.';
            if (auth.currentUser === null) {
                authenticateUser();
            }
        }
    });


    // --- Lógica de Firestore (Guardar Datos) ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !userId) {
            showToast('Error: Autenticación no completa. Espere unos segundos.', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';
        formMessage.textContent = '';
        
        try {
            // 1. Obtener valores
            const studentData = {
                name: nameInput.value.trim(),
                studentId: studentIdInput.value.trim(),
                email: emailInput.value.trim(),
                dob: dobInput.value,
                grade: gradeSelect.value,
                createdAt: serverTimestamp() 
            };

            // 2. Definir la ruta de la colección (Datos Privados)
            // /artifacts/{appId}/users/{userId}/students
            const studentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'students');

            // 3. Agregar el documento
            await addDoc(studentsColRef, studentData);

            // 4. Éxito
            showToast('Estudiante registrado exitosamente.', 'success');
            form.reset(); // Limpiar formulario
            
        } catch (error) {
            console.error("Error al guardar el estudiante:", error);
            formMessage.textContent = `Error al guardar: ${error.message}`;
            formMessage.className = 'text-sm font-medium text-red-600 transition-opacity duration-300';
            showToast('Error al registrar estudiante.', 'error');

        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Guardar Estudiante';
        }
    });

    // --- Lógica de Firestore (Cargar Datos en Tiempo Real) ---

    function startStudentListener() {
        if (!userId) {
            console.warn("No se puede iniciar el listener: userId no está disponible.");
            return;
        }

        const studentsColRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
        const q = query(studentsColRef); // Consulta sin ordenación para evitar problemas de índice

        // onSnapshot se mantiene escuchando los cambios en tiempo real
        onSnapshot(q, (snapshot) => {
            const students = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                students.push({ id: doc.id, ...data });
            });

            // Ordenar los estudiantes por nombre (ordenación en memoria)
            students.sort((a, b) => {
                return (a.name || '').localeCompare(b.name || '');
            });
            
            renderStudents(students);
        }, (error) => {
            console.error("Error al escuchar documentos:", error);
            studentsListContainer.innerHTML = `<p class="p-4 text-red-600">Error al cargar la lista: ${error.message}</p>`;
        });
    }

    function renderStudents(students) {
        studentCountElement.textContent = students.length;
        studentsListContainer.innerHTML = ''; // Limpiar lista anterior

        if (students.length === 0) {
            noStudentsMessage.classList.remove('hidden');
            return;
        }
        
        noStudentsMessage.classList.add('hidden');

        const table = document.createElement('table');
        table.className = 'min-w-full divide-y divide-gray-200';
        
        // Encabezado de la tabla con el nuevo estilo profesional
        table.innerHTML = `
            <thead class="bg-indigo-50 border-b border-indigo-200">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">Nombre</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider hidden sm:table-cell">Grado</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider hidden md:table-cell">F. Registro</th>
                </tr>
            </thead>
            <tbody id="table-body" class="bg-white divide-y divide-gray-100">
            </tbody>
        `;

        const tbody = table.querySelector('#table-body');
        
        students.forEach(student => {
            let formattedDate = 'N/A';
            if (student.createdAt && student.createdAt.toDate) {
                formattedDate = student.createdAt.toDate().toLocaleDateString('es-ES', { 
                    year: 'numeric', month: 'short', day: 'numeric' 
                });
            }
            
            const row = document.createElement('tr');
            // Estilo para filas alternas (se usa la clase .table-row)
            row.className = 'hover:bg-indigo-50 transition duration-150 table-row';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.studentId}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 truncate max-w-xs">${student.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium hidden sm:table-cell">
                    <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                        ${student.grade}°
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 hidden md:table-cell">${formattedDate}</td>
            `;
            tbody.appendChild(row);
        });

        studentsListContainer.appendChild(table);
    }

    // Iniciar el proceso de autenticación al cargar
    if (!auth.currentUser) {
         authenticateUser();
    }

</script>

</body>
</html>

<link rel="stylesheet" href="styles_base.css">
<link rel="stylesheet" href="styles_components.css">